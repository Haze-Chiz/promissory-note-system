<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Promissory Notes Statistics</title>
<link rel="icon" type="image/x-icon" href="/images/FCPC.jpg">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
/* Reset and base styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
body {
    font-family: 'Arial', sans-serif;
    line-height: 1.6;
    color: #333;
    background-color: #f9f9f9;
}

/* Sidebar */
.sidebar {
    width: 220px;
    height: 100vh;
    background: linear-gradient(135deg, #1e2a78, #3a4bb3);
    color: #fff;
    position: fixed;
    top: 0;
    left: 0;
    padding-top: 20px;
    display: flex;
    flex-direction: column;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
}
.sidebar h2 {
    text-align: center;
    font-size: 16px;
    margin: 0 10px 30px;
    font-weight: 300;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.sidebar a {
    display: flex;
    align-items: center;
    padding: 12px 20px;
    color: #fff;
    text-decoration: none;
    margin: 5px 0;
    transition: 0.3s;
}
.sidebar a:hover {
    background-color: rgba(255,255,255,0.1);
}
.sidebar a.active {
    background-color: rgba(255,255,255,0.25);
    font-weight: 600;
}
.sidebar img.icon {
    width: 30px;
    height: 30px;
    margin-right: 10px;
    background: #fff;
    border-radius: 50%;
    padding: 6px;
}
.logout-btn {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 20px;
}

/* Main content */
.main-content {
    margin-left: 220px;
    padding: 20px;
    min-height: 100vh;
}
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}
.header h2 {
    font-weight: 300;
    color: #2c3e50;
}

/* Cards */
.cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 30px;
}
.card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    padding: 20px;
    min-height: 150px;
}
.card .course-code {
    font-size: 16px;
    font-weight: 500;
    color: #1e2a78;
    line-height: 1.2;
    margin-bottom: 10px;
}
.card p {
    font-size: 24px;
    font-weight: 600;
    color: #333;
}

/* Filter card */
.card-filter {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    padding: 25px;
    margin-bottom: 30px;
}
.card-filter form {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
}
.card-filter form > div {
    display: flex;
    flex-direction: column;
}
.card-filter label {
    font-weight: 500;
    color: #1e2a78;
    display: block;
    margin-bottom: 6px;
}
.card-filter select,
.card-filter input {
    padding: 10px 16px;
    font-size: 14px;
    border: none;
    border-radius: 50px;
    background-color: #f1f3f8;
    color: #333;
    min-width: 160px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
}
.card-filter select:focus,
.card-filter input:focus {
    outline: none;
    background-color: #e6ebff;
    box-shadow: 0 4px 10px rgba(58, 75, 179, 0.2);
}
.card-filter button {
    background-color: #dc3545;
    color: #fff;
    border: none;
    padding: 10px 20px;
    font-size: 14px;
    border-radius: 50px;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}
.card-filter button:hover {
    background-color: #b02a37;
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

/* Chart cards */
.chart-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    padding: 30px;
    margin-bottom: 30px;
}
.chart-card h3 {
    color: #1e2a78;
    font-weight: 400;
    font-size: 20px;
    margin-bottom: 25px;
    text-align: center;
}
.chart-container {
    width: 100%;
    height: 400px;
}

/* Download / Export buttons */
.download-btn {
    background: #1e2a78;
    color: #fff;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    margin-left: 5px;
}
.download-btn:hover {
    background: #3a4bb3;
}
.export-btn {
    background-color: #1e2a78;
    color: #fff;
    border: none;
    padding: 10px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    margin-right: 10px;
    transition: 0.3s;
    display: inline-flex;
    align-items: center;
}
.export-btn:hover {
    background-color: #3a4bb3;
}
.export-btn i {
    margin-right: 6px;
}

/* Responsive */
@media(max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
        position: fixed;
        z-index: 1000;
    }
    .main-content {
        margin-left: 0;
        padding: 20px;
    }
    .cards {
        grid-template-columns: 1fr;
    }
}
</style>
</head>

<body>
<nav class="sidebar">
    <h2>{{ finance_user }}<br>Promissory Notes <br>Finance</h2>
    <a href="{{ url_for('finance.dashboard') }}" class="{% if request.endpoint=='finance.dashboard' %}active{% endif %}">
        <img src="{{ url_for('static', filename='images/dashboard.png') }}" class="icon"> Dashboard
    </a>
    <a href="{{ url_for('finance.promissory_notes') }}" class="{% if request.endpoint=='finance.promissory_notes' %}active{% endif %}">
        <img src="{{ url_for('static', filename='images/notes.png') }}" class="icon"> Promissory Notes
    </a>
    <a href="{{ url_for('finance.all_promissory') }}" class="{% if request.endpoint=='finance.all_promissory' %}active{% endif %}">
        <img src="{{ url_for('static', filename='images/notes.png') }}" class="icon"> Statistics
    </a>
    <a href="{{ url_for('finance.students_promissory') }}" class="{% if request.endpoint=='finance.students_promissory' %}active{% endif %}">
        <img src="{{ url_for('static', filename='images/students.png') }}" class="icon"> Students
    </a>
    <a href="{{ url_for('finance.logout') }}" class="logout-btn">
        <img src="{{ url_for('static', filename='images/logout.png') }}" class="icon"> Logout
    </a>
</nav>

<main class="main-content">
    <header class="header">
        <h2>Promissory Notes Statistics</h2>
        <div>Active Semester: <strong>{{ active_semester }}</strong> | S.Y.: <strong>{{ active_school_year }}</strong></div>
    </header>

    <!-- Filter Section -->
    <section class="card-filter">
        <form id="filterForm">
            <div>
                <label>Course</label>
                <select name="course" id="courseFilter">
                    <option value="">All</option>
                    {% for course in courses %}
                    <option value="{{ course }}" {% if course==selected_course %}selected{% endif %}>{{ course }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Semester</label>
                <select name="semester" id="semesterFilter">
                    <option value="all" {% if selected_semester == 'all' %}selected{% endif %}>All</option>
                    {% for sem in semesters %}
                    <option value="{{ sem }}" {% if sem == selected_semester %}selected{% endif %}>{{ sem }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>Status</label>
                <select name="status" id="statusFilter">
                    <option value="pending" {% if selected_status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if selected_status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="rejected" {% if selected_status == 'rejected' %}selected{% endif %}>Rejected</option>
                    <option value="all" {% if selected_status == 'all' %}selected{% endif %}>All</option>
                </select>
            </div>
            <div>
                <label>Examination Type</label>
                <select name="semester_type" id="semesterTypeFilter">
                    <option value="">All</option>
                    {% for semt in semester_types %}
                    <option value="{{ semt }}" {% if semt==selected_semester_type %}selected{% endif %}>{{ semt }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label>School Year</label>
                <select name="school_year" id="schoolYearFilter">
                    <option value="all" {% if selected_school_year == 'all' %}selected{% endif %}>All</option>
                    {% for sy in school_years %}
                    <option value="{{ sy }}" {% if sy == selected_school_year %}selected{% endif %}>{{ sy }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button type="button" onclick="clearFilters()">Clear</button>
            </div>
        </form>
    </section>

    <!-- Export Buttons -->
    <div style="margin-bottom: 20px; text-align:right;">
        <a href="{{ url_for('finance.all_promissory', export='excel', course=selected_course if selected_course else None, semester=selected_semester if selected_semester else None, semester_type=selected_semester_type if selected_semester_type else None, school_year=selected_school_year if selected_school_year else None, status=selected_status) }}" class="export-btn">Export Excel</a>

        <a href="{{ url_for('finance.all_promissory', export='csv', course=selected_course if selected_course else None, semester=selected_semester if selected_semester else None, semester_type=selected_semester_type if selected_semester_type else None, school_year=selected_school_year if selected_school_year else None, status=selected_status) }}" class="export-btn">Export CSV</a>
    </div>

    <!-- Statistic Cards -->
    <section class="cards">
        <div class="card">
            <div class="course-code">Total Students</div>
            <p>{{ total_students }}</p>
        </div>
        <div class="card">
            <div class="course-code">Total Students Requested Promissory</div>
            <p>{{ total_requested }}</p>
        </div>
    </section>

    <!-- Charts -->
    <section class="chart-card">
        <h3>Total vs Total Students Requested Promissory
            <button class="download-btn" onclick="downloadChartHighRes('promissoryChart','total_vs_requested.png')">Download</button>
        </h3>
        <div class="chart-container">
            <canvas id="promissoryChart"></canvas>
        </div>
    </section>

    <section class="chart-card">
        <h3>Course Requests (Lowest â†’ Highest)
            <button class="download-btn" onclick="downloadChartHighRes('courseBarChart','course_requests.png')">Download</button>
        </h3>
        <div class="chart-container">
            <canvas id="courseBarChart"></canvas>
        </div>
    </section>

</main>

<script>
// Apply filters
function applyFilters() {
    const course = document.getElementById('courseFilter').value;
    const semester = document.getElementById('semesterFilter').value;
    const semester_type = document.getElementById('semesterTypeFilter').value;
    const school_year = document.getElementById('schoolYearFilter').value;
    const status = document.getElementById('statusFilter').value;

    const params = new URLSearchParams(window.location.search);
    course ? params.set('course', course) : params.delete('course');
    semester ? params.set('semester', semester) : params.delete('semester');
    semester_type ? params.set('semester_type', semester_type) : params.delete('semester_type');
    school_year ? params.set('school_year', school_year) : params.delete('school_year');
    status ? params.set('status', status) : params.delete('status'); 

    window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
    window.location.reload();
}

// Event listeners for filters
['courseFilter','semesterFilter','semesterTypeFilter','schoolYearFilter','statusFilter'].forEach(id =>
    document.getElementById(id).addEventListener('change', applyFilters)
);

// Clear filters
function clearFilters() {
    ['courseFilter','semesterFilter','semesterTypeFilter','schoolYearFilter'].forEach(id => {
        document.getElementById(id).value = '';
    });
    applyFilters();
}

// Download chart in high resolution
function downloadChartHighRes(chartId, filename) {
    const originalCanvas = document.getElementById(chartId);
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = 1920;
    tempCanvas.height = 1080;
    const ctx = tempCanvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,tempCanvas.width,tempCanvas.height);
    const scale = Math.min(tempCanvas.width/originalCanvas.width, tempCanvas.height/originalCanvas.height);
    const offsetX = (tempCanvas.width - originalCanvas.width*scale)/2;
    const offsetY = (tempCanvas.height - originalCanvas.height*scale)/2;
    ctx.drawImage(originalCanvas, offsetX, offsetY, originalCanvas.width*scale, originalCanvas.height*scale);
    const link = document.createElement('a');
    link.href = tempCanvas.toDataURL('image/png',1.0);
    link.download = filename;
    link.click();
}

// Export data
function exportData(format) {
    const params = new URLSearchParams(window.location.search);
    params.set('export', format);

    const course = document.getElementById('courseFilter').value;
    const semester = document.getElementById('semesterFilter').value;
    const semester_type = document.getElementById('semesterTypeFilter').value;
    const school_year = document.getElementById('schoolYearFilter').value;

    course ? params.set('course', course) : params.delete('course');
    semester ? params.set('semester', semester) : params.delete('semester');
    semester_type ? params.set('semester_type', semester_type) : params.delete('semester_type');
    school_year ? params.set('school_year', school_year) : params.delete('school_year');

    window.location.href = `${window.location.pathname}?${params.toString()}`;
}

// Charts
const promissoryCtx = document.getElementById('promissoryChart').getContext('2d');
new Chart(promissoryCtx,{
    type:'bar',
    data:{
        labels:['Total Students','Total Students Requested Promissory'],
        datasets:[{
            label:'Students',
            data:[{{ total_students }}, {{ total_requested }}],
            backgroundColor:['#1e2a78','#28a745'],
            borderColor:['#1e2a78','#28a745'],
            borderWidth:2,
            borderRadius:6
        }]
    },
    options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
            legend:{ display:false },
            datalabels:{
                color:'#fff',
                anchor:'center',
                align:'center',
                font:{ weight:'bold', size:14 },
                formatter:(value,ctx) => {
                    const total = ctx.chart.data.datasets[0].data.reduce((a,b)=>a+b,0);
                    return `${value} (${((value/total)*100).toFixed(0)}%)`;
                }
            }
        },
        scales:{
            y:{ beginAtZero:true, ticks:{ precision:0 } },
            x:{ grid:{ display:false } }
        }
    },
    plugins:[ChartDataLabels]
});

new Chart(document.getElementById('courseBarChart').getContext('2d'),{
    type:'bar',
    data:{
        labels: {{ courses_sorted|safe }},
        datasets:[{
            label:'Student Requests',
            data: {{ counts_sorted|safe }},
            backgroundColor:'#1e2a78',
            borderColor:'#1e2a78',
            borderWidth:2,
            borderRadius:6
        }]
    },
    options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{ bottom:120 } },
        plugins:{
            legend:{ display:false },
            datalabels:{ display:false },
            tooltip:{
                callbacks:{
                    label:function(context){
                        const index=context.dataIndex;
                        const requests=context.dataset.data[index];
                        const total={{ totals_sorted|safe }}[index];
                        const percent={{ percentages_sorted|safe }}[index];
                        return `Requests: ${requests}, Total Students: ${total} (${percent}%)`;
                    }
                }
            }
        },
        scales:{
            y:{ beginAtZero:true, ticks:{ precision:0 } },
            x:{ grid:{ display:false }, ticks:{ autoSkip:false, maxRotation:90, minRotation:90, font:{ size:10 } } }
        }
    }
});
</script>

</body>
</html>
